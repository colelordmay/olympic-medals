<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Olympic Medals Women’s Ratio Map</title>
    <script src="https://d3js.org/d3.v6.js"></script>
    <style>
      body {
        font-family: Roboto, sans-serif;
        margin: 20px;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #controls-container {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }

      label {
        font-weight: 700;
        font-size: 16px;
        color: #333333;
        margin-right: 5px;
      }

      select,
      #minMedalsSlider {
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1.5px solid #cccccc;
        background-color: #ffffff;
        cursor: pointer;
        transition: border-color 0.3s ease;
      }

      select:hover,
      #minMedalsSlider:hover {
        border-color: #888888;
      }

      #minMedalsSlider {
        -webkit-appearance: none;
        appearance: none;
        width: 200px;
        height: 8px;
        border-radius: 5px;
        background-color: #dddddd;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        padding: 0;
      }

      #minMedalsSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 23px;
        height: 23px;
        transform: translateY(-8px);
        background-color: #bbbbbb;
        border: 1.8px solid #555555;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        cursor: pointer;
      }

      #minMedalsSlider:hover::-webkit-slider-thumb {
        border-color: #333333;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      }

      #minMedalsSlider::-moz-range-thumb {
        width: 26px;
        height: 26px;
        background-color: #bbbbbb;
        border: 1.8px solid #555555;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        cursor: pointer;
      }

      #minMedalsSlider:hover::-moz-range-thumb {
        border-color: #333333;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      }

      #minMedalsSlider::-moz-range-track {
        background-color: #dddddd;
        height: 8px;
        border-radius: 5px;
      }

      #minMedalsSlider::-webkit-slider-runnable-track {
        background-color: #dddddd;
        height: 8px;
        border-radius: 5px;
      }

      #slider-label {
        font-weight: 600;
        font-size: 14px;
        color: #555555;
        width: 40px;
        text-align: center;
        user-select: none;
      }

      #tooltip {
        position: absolute;
        padding: 6px;
        font: 12px sans-serif;
        background-color: #ffffff;
        border: 1px solid #999999;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
      }

      #colorbar-container {
        width: 1000px;
        height: 100px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div id="colorbar-container">
      <svg id="colorbar_svg" width="1000" height="100"></svg>
    </div>

    <div id="controls-container">
      <label for="seasonSelect">Season:</label>
      <select id="seasonSelect">
        <option value="both" selected>Both</option>
        <option value="summer">Summer</option>
        <option value="winter">Winter</option>
      </select>

      <label for="minMedalsSlider">Minimum medals:</label>
      <input type="range" id="minMedalsSlider" min="1" max="50" value="10" step="1" />
      <span id="slider-label" aria-live="polite">10</span>
    </div>

    <svg id="data" width="967" height="600" style="border: 1px solid #333333;">
      <defs>
        <pattern id="hashPattern" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(60)">
          <rect width="8" height="8" fill="#f5f5f5"></rect>
          <line x1="0" y="0" x2="0" y2="8" stroke="#a0a0a0" stroke-width="1"></line>
        </pattern>
      </defs>
    </svg>

    <div id="tooltip" role="tooltip"></div>

    <script>
      // ------------------ CONSTANTS ------------------
      const width = 967,
            height = 600;

      const svg = d3.select("#data"),
            g = svg.append("g");

      const tooltip = d3.select("#tooltip");

      const slider = d3.select("#minMedalsSlider"),
            sliderLabel = d3.select("#slider-label");

      const seasonSelect = d3.select("#seasonSelect");

      let topo, data = new Map();

      const projection = d3.geoMercator()
                           .scale(140)
                           .center([0, 20])
                           .translate([width / 2 - 43, height / 2]);

      const path = d3.geoPath().projection(projection);

      const colorScale = d3.scaleDiverging()
                           .domain([0.3, 0.5, 0.7])
                           .interpolator(t => {
                             const colors = [
                               d3.rgb("#d62728"),
                               d3.rgb("#f7f7a5"),
                               d3.rgb("#2ca02c")
                             ];
                             return t < 0.5
                               ? d3.interpolateRgb(colors[0], colors[1])(t / 0.5)
                               : d3.interpolateRgb(colors[1], colors[2])((t - 0.5) / 0.5);
                           })
                           .clamp(true);

      const dataURLs = {
        both: "https://raw.githubusercontent.com/colelordmay/olympic-medals/master/data/both_counts.csv",
        summer: "https://raw.githubusercontent.com/colelordmay/olympic-medals/master/data/summer_counts.csv",
        winter: "https://raw.githubusercontent.com/colelordmay/olympic-medals/master/data/winter_counts.csv",
      };

      // ------------------ INITIALIZATION ------------------
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
        .then(world => {
          topo = world;
          loadMedalDataAndDraw("both");
        });

      svg.insert("rect", ":first-child")
         .attr("id", "oceanRect")
         .attr("width", width)
         .attr("height", height)
         .attr("fill", "#e6f0f6");

      // ------------------ FUNCTIONS ------------------
      function loadMedalDataAndDraw(season) {
        d3.csv(dataURLs[season], d => ({
          country: d.country,
          ratio: +d.ratio,
          total: +d.total,
        })).then(rawData => {
          data = new Map(rawData.map(d => [d.country, { ratio: d.ratio, total: d.total }]));
          topo.features.forEach(f => {
            if (!data.has(f.id)) {
              data.set(f.id, { ratio: 0, total: 0 });
            }
          });
          updateMap(+slider.property("value"));
        });
      }

      function updateMap(minMedals) {
        sliderLabel.text(minMedals);

        g.selectAll("path")
          .data(topo.features)
          .join("path")
          .attr("d", path)
          .attr("fill", d => {
            const datum = data.get(d.id);
            return !datum || datum.total < minMedals
              ? "url(#hashPattern)"
              : colorScale(datum.ratio);
          })
          .attr("stroke", "#333333")
          .attr("vector-effect", "non-scaling-stroke")
          .style("stroke-width", "0.9px")
          .style("opacity", 1)
          .on("mouseover", (event, d) => {
            d3.selectAll("path")
              .interrupt()
              .transition()
              .duration(50)
              .style("opacity", 0.74);

            d3.select("#oceanRect")
              .transition()
              .duration(50)
              .style("opacity", 0.45);

            d3.select(event.currentTarget)
              .transition()
              .duration(50)
              .style("opacity", 1)
              .attr("stroke", "black");

            const datum = data.get(d.id);

            tooltip.style("opacity", 1)
                   .html(`<strong>${d.properties.name}</strong><br>Women’s medal ratio: ${
                           datum?.ratio != null
                             ? (datum.ratio * 100).toFixed(1) + "%"
                             : "0.0%"
                         }<br>Total medals: ${datum?.total ?? 0}`);
          })
          .on("mousemove", event => {
            tooltip.style("left", event.pageX + 10 + "px")
                   .style("top", event.pageY + 10 + "px");
          })
          .on("mouseleave", () => {
            d3.selectAll("path")
              .interrupt()
              .transition()
              .style("opacity", 1)
              .attr("stroke", "#333333");

            d3.select("#oceanRect")
              .transition()
              .duration(50)
              .style("opacity", 1);

            tooltip.style("opacity", 0);
          });
      }

      // ------------------ INTERACTIONS ------------------
      svg.call(d3.zoom()
                .scaleExtent([1, 10])
                .on("zoom", event => g.attr("transform", event.transform)))
         .call(d3.zoom().transform, d3.zoomIdentity.scale(1.1));

      slider.on("input", () => updateMap(+slider.property("value")));

      seasonSelect.on("change", () => loadMedalDataAndDraw(seasonSelect.property("value")));

      // ------------------ COLORBAR ------------------
      const colorbarSvg = d3.select("#colorbar_svg");

      const gradientWidth = 700,
            gradientHeight = 35,
            gradientX = 150,
            gradientY = 35,
            triangleWidth = 20;

      const defs = colorbarSvg.append("defs");

      const linearGradient = defs.append("linearGradient")
                                 .attr("id", "colorbar-gradient")
                                 .attr("x1", "0%")
                                 .attr("y1", "0%")
                                 .attr("x2", "100%")
                                 .attr("y2", "0%");

      const numStops = 10;

      for (let i = 0; i <= numStops; i++) {
        const t = 0.3 + (0.4 * i) / numStops;
        const normT = (t - 0.3) / 0.4;
        linearGradient.append("stop")
                      .attr("offset", `${normT * 100}%`)
                      .attr("stop-color", colorScale(t));
      }

      colorbarSvg.append("rect")
                 .attr("x", gradientX)
                 .attr("y", gradientY)
                 .attr("width", gradientWidth)
                 .attr("height", gradientHeight)
                 .style("fill", "url(#colorbar-gradient)");

      colorbarSvg.append("polygon")
                 .attr("points", `${gradientX},${gradientY} ${gradientX - triangleWidth},${gradientY + gradientHeight / 2} ${gradientX},${gradientY + gradientHeight}`)
                 .attr("fill", colorScale(0.3));

      colorbarSvg.append("polygon")
                 .attr("points", `${gradientX + gradientWidth},${gradientY} ${gradientX + gradientWidth + triangleWidth},${gradientY + gradientHeight / 2} ${gradientX + gradientWidth},${gradientY + gradientHeight}`)
                 .attr("fill", colorScale(0.7));

      const xScale = d3.scaleLinear()
                       .domain([0.3, 0.7])
                       .range([gradientX, gradientX + gradientWidth]);

      colorbarSvg.append("g")
                 .attr("transform", `translate(0,${gradientY + gradientHeight})`)
                 .call(d3.axisBottom(xScale)
                        .tickValues([0.3, 0.4, 0.5, 0.6, 0.7])
                        .tickFormat(d => `${Math.round(d * 100)}%`))
                 .selectAll("text")
                 .attr("font-size", "16px");

      colorbarSvg.append("text")
                 .attr("x", gradientX + gradientWidth / 2)
                 .attr("y", gradientY - 15)
                 .attr("text-anchor", "middle")
                 .attr("font-weight", "700")
                 .attr("font-size", "20px")
                 .attr("fill", "#333333")
                 .text("Percentage of Olympic medals won by women");
    </script>
  </body>
</html>
